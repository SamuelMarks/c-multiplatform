name: ci

on:
  push:
  pull_request:

jobs:
  desktop:
    name: desktop-${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Install libcurl (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev
      - name: Configure
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
      - name: Build
        run: cmake --build build --config Release
      - name: Test
        run: ctest --test-dir build -C Release --output-on-failure

  android:
    name: android
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      - name: Install NDK
        run: |
          yes | sdkmanager "ndk;25.2.9519653"
          echo "ANDROID_NDK_HOME=${ANDROID_SDK_ROOT}/ndk/25.2.9519653" >> $GITHUB_ENV
      - name: Configure
        run: |
          cmake -S . -B build-android \
            -DCMAKE_TOOLCHAIN_FILE="$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake" \
            -DANDROID_ABI=armeabi-v7a \
            -DANDROID_PLATFORM=android-21 \
            -DANDROID_STL=c++_static \
            -DM3_ENABLE_LIBCURL=OFF
      - name: Build
        run: cmake --build build-android

  web:
    name: web
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v12
      - name: Configure
        run: emcmake cmake -S . -B build-web -DCMAKE_BUILD_TYPE=Release -DM3_ENABLE_LIBCURL=OFF
      - name: Build
        run: cmake --build build-web

  docs:
    name: docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz libcurl4-openssl-dev
      - name: Configure
        run: cmake -S . -B build-docs -DCMAKE_BUILD_TYPE=Release -DM3_REQUIRE_DOXYGEN=ON
      - name: Generate Docs (Doxygen)
        run: ctest --test-dir build-docs -R m3_docs --output-on-failure

  coverage:
    name: coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install gcovr
        run: |
          sudo apt-get update
          sudo apt-get install -y gcovr libcurl4-openssl-dev
      - name: Configure
        env:
          CC: gcc
        run: cmake -S . -B build-coverage -DCMAKE_BUILD_TYPE=Debug -DM3_ENABLE_COVERAGE=ON -DM3_REQUIRE_DOXYGEN=OFF
      - name: Build
        run: cmake --build build-coverage
      - name: Test
        run: ctest --test-dir build-coverage --output-on-failure
      - name: Coverage (Phase 1)
        run: |
          gcovr -r . --object-directory build-coverage \
            --filter 'src/.*' \
            --print-summary \
            --fail-under-line 100 \
            --fail-under-function 100 \
            --xml-pretty -o build-coverage/coverage.xml
